<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forms Pending Your Approval</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link href="/css/style.css" rel="stylesheet">
</head>

<body onload="findRelationships()">

    <div class="wrapper-view">
        <div class="container-xxl container-color">
            <h2 class="container-text">View Forms That Need Your Approval</h2>

            <table id="myTable" class="table table-bordered table-striped table-hover" style="width: 100%;">
                <thead>
                    <th>Employee</td>
                    <th>Date Submitted</td>
                    <th>Status</td>
                    <th>
                        </td>

                </thead>
            </table>


            <div>
                <!-- if a supervisor, add extra button-->
                <button id="back-button">Back</button>
            </div>

            </button>
        </div>

    </div>

</body>

<script>

    function viewClick(id) {
        location.href = "viewFormDetails.html";
    }

    async function approveClick(id) {
        console.log("Approved");

        let childElement = document.getElementById(id);

        let pElementID = childElement.parentElement.id;

        let pElement = document.getElementById(pElementID);

        let tableRowElementID = pElement.parentElement.id;

        let tableRowElement = document.getElementById(tableRowElementID);

        // console.log(id);
        // console.log(pElement);
        // console.log(tableRowElement);

        let form = await getFormInfo(tableRowElementID);
        form = form.body;

        console.log(form);

        if (localStorage.jobPosition == "Teacher") {

            form.approval.status = "waiting for Department Head approval";


        } else if (localStorage.jobPosition == "Department Head") {

            form.approval.status = "waiting for BenCo Coordinator approval";

        } else if (localStorage.jobPosition == "HR Representative") {

            form.approval.status = "Pending";


        }

        console.log(form);

        updateApproval(form);

        tableRowElement.remove();

        // tableRowElement.parentElement.removeChild(tableRowElement);
    }

    async function updateApproval(form) {

        // let employee = await getEmployeeInfo(form.eID);

        const data = {

            "status": form.approval.status

        }

        const url = `http://localhost:7000/approvals/${form.approval.aID}`;

        const httpResponse = await fetch(url, {
            method: "PUT",
            body: JSON.stringify(data)
        });

        const body = await httpResponse.json();

        console.log(body);

        return { body };

    }

    async function denyClick(id) {
        console.log("Denied");

        let childElement = document.getElementById(id);

        let pElementID = childElement.parentElement.id;

        let pElement = document.getElementById(pElementID);

        let tableRowElementID = pElement.parentElement.id;

        let tableRowElement = document.getElementById(tableRowElementID);

        console.log(id);
        console.log(pElement);
        console.log(tableRowElement);

        let form = await getFormInfo(tableRowElementID);
        form = form.body;

        console.log(form);

        form.approval.status = "Denied";

        updateApproval(form);

        tableRowElement.remove();

        // tableRowElement.parentElement.removeChild(tableRowElement);

        // findRelationships();
    }




    document.getElementById('back-button').onclick = function () {
        location.href = "portal.html";
    }

    // this needs to be changed to fit my form URL and fetching
    async function getSupervisorEmployeeInfo() {

        const id = localStorage.eID;
        const url = `http://localhost:7000/supervisoremployees`;

        const httpResponse = await fetch(url);
        const body = await httpResponse.json();

        return { body }

    }

    async function getFormInfo(id) {

        // const id = id;
        const url = `http://localhost:7000/forms/${id}`;

        const httpResponse = await fetch(url);
        const body = await httpResponse.json();

        return { body }

    }

    async function getEmployeeInfo(id) {

        // const id = id;
        const url = `http://localhost:7000/employee/${id}`;

        const httpResponse = await fetch(url);
        const body = await httpResponse.json();

        // console.log(body);
        return { body }

    }

    async function populateTable(formNeeded, employee) {

        let form = await getFormInfo(formNeeded);
        form = form.body;

        // let employee = await getEmployeeInfo(form.eID);

        // console.log(employeeID);
        // console.log(employee);


        // employee = employee.body;

        let myTable = document.getElementById("myTable");

        let tableRow = document.createElement("tr");

        // add unique id to table row that corresponds with
        // form's id
        tableRow.id = form.fID;

        let employeeName = document.createElement("td");
        let dateSubmitted = document.createElement("td");
        let status = document.createElement("td");
        let approvalButtons = document.createElement("td");

        // buttons needed
        let viewBtn = document.createElement("button");
        let approveBtn = document.createElement("button");
        let denyBtn = document.createElement("button");

        // add appropriate class names to each data entry in row
        // eID.className = "employee-id";
        // dateSubmitted.className = "date-submitted";
        // status.className = "status";
        // approvalButtons.className = "approval-buttons";

        employeeName.id = "employee-name" + i;
        dateSubmitted.id = "date-submitted" + i;
        status.id = "status" + i;
        approvalButtons.id = "approval-buttons" + i;

        viewBtn.id = "view-button";
        approveBtn.id = "approve-button";
        denyBtn.id = "deny-button";

        viewBtn.innerHTML = "View Details";
        approveBtn.innerHTML = "Approve";
        denyBtn.innerHTML = "Deny";

        approveBtn.style.display = "inline";
        denyBtn.style.display = "inline";

        approveBtn.style.width = "50%";
        denyBtn.style.width = "50%";

        // eventType.style.width = "25%";
        // dateSubmitted.style.width = "45%";
        // status.style.width = "33%";

        viewBtn.onclick = function () { viewClick(this.id); };
        approveBtn.onclick = function () { approveClick(this.id); };
        denyBtn.onclick = function () { denyClick(this.id); };

        let d = new Date(form.dateTimeCompleted * 1000);

        // add displayed HTML
        employeeName.innerHTML = employee.lastName + ", " + employee.firstName;
        dateSubmitted.innerHTML = d;

        status.appendChild(viewBtn);

        approvalButtons.appendChild(approveBtn);
        approvalButtons.appendChild(denyBtn);

        approvalButtons.style.padding = "25px";


        // status.innerHTML = form[i].approval.status;

        // myTable.appendChild(tableRow);

        tableRow.appendChild(employeeName);
        tableRow.appendChild(dateSubmitted);
        tableRow.appendChild(status);
        tableRow.appendChild(approvalButtons);


        myTable.appendChild(tableRow);

    }


    async function getEmployeeForms(id) {

        // fetch the forms of that employee
        const url = `http://localhost:7000/employees/${id}/forms`;

        const httpResponse = await fetch(url);
        const body = await httpResponse.json();

        console.log(body);

        return { body };

    }

    async function findRelationships() {

        let employeeRelationships = await getSupervisorEmployeeInfo();

        employeeRelationships = employeeRelationships.body;


        for (const employee in employeeRelationships) {
            const element = employeeRelationships[employee];

            // console.log(localStorage.jobPosition);
            // console.log("am i here?")

            // console.log(element);

            let currentEmployee = await getEmployeeInfo(element.eID);
            currentEmployee = currentEmployee.body;

            // console.log(currentEmployee);

            // determine the job position of the current employee signed in
            if (localStorage.jobPosition == "Teacher") {

                // if there is a direct supervisor -> employee relationship
                if (element.sID == localStorage.eID) {
                    let currentEmployeeForms = await getEmployeeForms(currentEmployee.eID);
                    currentEmployeeForms = currentEmployeeForms.body;

                    // console.log(currentEmployee.eID);
                    //console.log(currentEmployeeForms);

                    for (i = 0; i < currentEmployeeForms.length; i++) {

                        // if there are forms requiring direct supervisor approval
                        if (currentEmployeeForms[i].approval.status == "waiting for Direct Supervisor approval") {


                            let formNeeded = currentEmployeeForms[i].fID;
                            // let employeeID = currentEmployee.eID;

                            populateTable(formNeeded, currentEmployee);

                        }

                    }

                }

            } else if (localStorage.jobPosition == "Department Head") {

                if (currentEmployee.department.deptName == localStorage.deptName) {
                    let currentEmployeeForms = await getEmployeeForms(currentEmployee.eID);
                    currentEmployeeForms = currentEmployeeForms.body;

                   // console.log(currentEmployeeForms);

                    for (i = 0; i < currentEmployeeForms.length; i++) {

                        // if there are forms requiring direct supervisor approval
                        if (currentEmployeeForms[i].approval.status == "waiting for Department Head approval") {


                            let formNeeded = currentEmployeeForms[i].fID;
                            // let employeeID = currentEmployee.eID;

                            populateTable(formNeeded, currentEmployee);

                        }
                    }
                }

            } else if (localStorage.jobPosition == "HR Representative") {
                    let currentEmployeeForms = await getEmployeeForms(currentEmployee.eID);
                    currentEmployeeForms = currentEmployeeForms.body;

                    // console.log(currentEmployeeForms);

                    for (i = 0; i < currentEmployeeForms.length; i++) {

                        // if there are forms requiring direct supervisor approval
                        if (currentEmployeeForms[i].approval.status == "waiting for BenCo Coordinator approval") {


                            let formNeeded = currentEmployeeForms[i].fID;
                            // let employeeID = currentEmployee.eID;

                            populateTable(formNeeded, currentEmployee);



                        }

                    }

                }
            }
        }

</script>

</html>