<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit a Form</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link href="/css/style.css" rel="stylesheet">
</head>

<body>

    <div class="wrapper-submit">
        <div class="container-lg container-color">
            <h2 class="container-text p-5">Enter info for your new Reimbursement Event request:</h2>

            <div id="form" class="form-group">

                <div class="div-inline">

                    <div class="input-group mb-3 form-control">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">Event Types</button>
                        <ul class="dropdown-menu" id="dropmenu">
                            <li class="dropdown-item di1" onclick="fillEvent(this.id)" id="universityCourseInput"> University Course</li>
                            <li class="dropdown-item" onclick="fillEvent(this.id)" id="seminarInput">Seminar</li>
                            <li class="dropdown-item" onclick="fillEvent(this.id)" id="certPrepClassInput">Certification Preparation Class</li>
                            <li class="dropdown-item" onclick="fillEvent(this.id)" id="certificationInput">Certification</li>
                            <li class="dropdown-item" onclick="fillEvent(this.id)" id="techTrainingInput">Technical Training</li>
                            <li class="dropdown-item" onclick="fillEvent(this.id)" id="otherInput">Other</li>
                        </ul>
                        <input type="text" class="form-control" id="dropInput"
                            aria-label="Text input with dropdown button">

                        <label for="reimbursementPercentage" class="container-text p-3">Reimbursement Coverage
                            (Percentage):<label></label>
                            <input id="reimbursementPercentage" class="form-input-submit form-control" type="number"
                                placeholder="" readonly>
                    </div>
                </div>

                <!-- I need to change the ids for all these inputs -->
                <div class="container-text pt-3 form-control">

                    <label for="dateTimeInput" class="form-label">Date of Event:<label></label>
                        <input id="dateInput" class="form-input-submit" type="date" placeholder="Month/Day/Year">

                        <label for="timeInput" class="form-label form-right">Time of Event:<label></label>
                            <input id="timeInput" class="form-input-submit" type="time" placeholder="">

                </div>

                <div class="container-text pt-3">

                    <label for="address1Input" class="form-label form-control">Address:<label></label>
                        <input id="address1Input" class="form-input-submit form-address" type="text" placeholder="">

                </div>

                <div class="container-text pt-3">

                    <label for="address2Input" class="form-label form-control"><label></label>
                        <input id="address2Input" class="form-input-submit form-address" type="text"
                            placeholder="Apt, suite, floor, etc. (Optional)">

                </div>

                <div class="container-text mt-3 pt-3 form-control">

                    <label for="cityInput" class="form-label ">City:<label></label>
                        <input id="cityInput" class="form-input-submit" type="text" placeholder="">

                        <!-- This is for all the states in US-->
                        <select name="state" id="stateInput" class="form-label form-right">
                            <option value="" selected="selected">Select a State</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="DC">District Of Columbia</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>

                </div>

                <div class="container-text mt-3 pt-3 form-control">

                    <label for="zipInput" class="form-label">ZIP:<label></label>
                        <input id="zipInput" class="form-input-submit" type="text" placeholder="" maxlength="5">

                        <label for="costInput" class="form-label form-right">Cost:<label></label>
                            <input id="costInput" class="form-input-submit" type="number" placeholder="">

                </div>

                <div class="container-text pt-3">

                    <label for="justificationInput" class="form-label form-control"><label>Work Justification</label>
                        <input id="justificationInput" class="form-input-submit form-address" type="text"
                            placeholder="max of 200 characters" maxlength="200">

                        <!-- <textarea name="textarea" style="width:250px;height:150px;"></textarea> -->

                </div>

                <div class="container-text pt-3 form-control">
                    <label>The grading format of this event is:</label><br>
                    <label for="grade">Grade</label>
                    <input type="radio" id="grade" value="passing grade" name="gradingFormat" checked>
                    <label for="presentation" class="form-right">Presentation</label>
                    <input type="radio" id="presentation" value="presentation to management" name="gradingFormat">

                </div>

                <div class="mb-3 form-control mt-3">
                    <label for="formFile" class="form-label">Related Attachments (Optional)</label>
                    <input class="form-control" type="file" id="formFile">
                </div>

                <div class="input-group mb-3">
                    <div class="input-group-text">
                        <label for="formVerification">"I certify that the information entered is all true to the best of
                            my ability:"&emsp;</label>
                        <input id="formVerification" class="form-check-input mt-0" type="checkbox" value=""
                            aria-label="Checkbox for following text input" required>
                    </div>
                </div>

                <div>
                    <button id="submit-button" class="mb-4" onclick="populateInfo()">Submit</button>

                    <!-- if a supervisor, add extra button-->
                    <button id="back-button" class="form-back-button">Back</button>
                </div>


            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script href="script.js"></script>
</body>

<script>

    function fillEvent(id) {

        let event = document.getElementById(id).innerHTML;

        document.getElementById('dropInput').value = event;

        if (id == 'universityCourseInput') {

            document.getElementById('reimbursementPercentage').value = 80;

        } else if (id == 'seminarInput') {

            document.getElementById('reimbursementPercentage').value = 60;

        } else if (id == 'certPrepClassInput') {

            document.getElementById('reimbursementPercentage').value = 75;

        } else if (id == 'certificationInput') {

            document.getElementById('reimbursementPercentage').value = 100;

        } else if (id == 'techTrainingInput') {

            document.getElementById('reimbursementPercentage').value = 90;

        } else {

            document.getElementById('reimbursementPercentage').value = 30;

        }

    }

    /*
        Adding Event Listener to 'listen' when a state is selected and 
        retrieve the ID of corresponding state (which will be the 2 letter abbreviation)
    */

    document.getElementById('stateInput').addEventListener("change", function () {
        let state = this.value;

        console.log(state);
    });

    document.getElementById('back-button').onclick = function () {
        location.href = "portal.html";
    }


    async function addApproval() {

        data = {
            "status": "waiting for Direct Supervisor approval"
        }

        const url = "http://localhost:7000/approvals";

        const httpResponse = await fetch(url, {
            method: "POST",
            body: JSON.stringify(data)
        });

        // const body = await JSON.stringify(httpResponse.json());
        const body = await httpResponse.json();

        console.log(body);

        console.log(JSON.stringify(body));

        return { body };

    }

    async function addEvent() {

        const dropValue = document.getElementById("dropInput").value;

        const dateValue = document.getElementById("dateInput").value;
        const timeValue = document.getElementById("timeInput").value;


        const address1Value = document.getElementById("address1Input").value;
        const address2Value = document.getElementById("address2Input").value;
        const cityValue = document.getElementById("cityInput").value;
        const stateValue = document.getElementById("stateInput").value;
        const zipValue = document.getElementById("zipInput").value;

        const costValue = document.getElementById("costInput").value;

        data = {
            "typeOf": dropValue,
            "startDate": 1637162310770,
            "addressLine1": address1Value,
            "addressLine2": address2Value,
            "city": cityValue,
            "state": stateValue,
            "zipcode": zipValue,
            "rCost": costValue
        }

        console.log(data);

        const url = "http://localhost:7000/events";

        const httpResponse = await fetch(url, {
            method: "POST",
            body: JSON.stringify(data)
        });

        const body = await httpResponse.json();

        return { body };

    }

    async function submitForm(approval, event) {

        const percentageValue = document.getElementById("reimbursementPercentage").value;


        const justificationValue = document.getElementById("justificationInput").value;

        const gradingFormats = document.getElementsByName("gradingFormat");
        for (grading of gradingFormats) {
            if (grading.checked) {
                gradeFormatValue = grading.value;
            }
        }

        let gID = 0;

        if (gradeFormatValue === "presentation to management") {
            gID = 1;

        } else if (gradeFormatValue === "passing grade") {
            gID = 2
        }

        const data = {

            "employee": {
                "eID": localStorage.eID,
                "firstName": localStorage.firstName,
                "lastName": localStorage.lastName,
                "jobPosition": localStorage.jobPosition,
                "username": localStorage.username,
                "password": localStorage.password,
                "email": localStorage.email,
                "department": {
                    "dID": localStorage.dID,
                    "deptName": localStorage.deptName
                }
            },
            "dateTimeCompleted": Date.now(),
            "event": {
                "rID": event.body.rID,
                "typeOf": event.body.typeOf,
                "startDate": 1637162310770,
                "addressLine1": event.body.addressLine1,
                "addressLine2": event.body.addressLine2,
                "city": event.body.city,
                "state": event.body.state,
                "zipcode": event.body.zipcode,
                "rCost": event.body.rCost,
            },
            "gradingFormat": {
                "gID": gID,
                "requirement":gradeFormatValue
            },
            "workJustification": justificationValue,
            "earnedGrade":null,
            "approval": {
                "aID": approval.body.aID,
                "status": approval.body.status
             }

        }

        const url = "http://localhost:7000/forms";

        const httpResponse = await fetch(url, {
            method: "POST",
            body: JSON.stringify(data)
        });

        const body = await httpResponse.json();

        return{ body };

    }

    function clearForm() {

        document.getElementById("dropInput").value = '';

        document.getElementById("dateInput").value = '';
        document.getElementById("timeInput").value = '';


        document.getElementById("address1Input").value = '';
        document.getElementById("address2Input").value = '';
        document.getElementById("cityInput").value = '';
        document.getElementById("stateInput").value = '';
        document.getElementById("zipInput").value = '';

        document.getElementById("costInput").value = '';

        document.getElementById("reimbursementPercentage").value = '';


        document.getElementById("justificationInput").value = '';

        document.getElementById("grade").checked = true;

        let formCheckbox = document.getElementById("formVerification").checked = false;

    }

    async function populateInfo() {


        let approval = await addApproval();

        const aElement = approval.body.aID

        // event code
        let event = await addEvent();

        const rElement = event.body.rID

        let s = await submitForm(approval, event);

        clearForm();

        alert("Your form has been submitted!")


    }


</script>

</html>